function getType(o) { 
	var _t; 
	return ((_t = typeof(o)) == "object" ? o==null && "null" || Object.prototype.toString.call(o).slice(8,-1):_t).toLowerCase(); 
}
function dfsObject(obj){
	var curType = getType(obj);
	var outPut = '';
	if(curType == 'object'||curType == 'array'){
		for(var key in obj){
			console.log('\n'+key+' : '+dfsObject(obj[key]));
		}
	}
	else{
		return obj;
	}
}
pie.selectUploadWay = function(){
	pie.showShadow();
	jQuery('#messageControlBox').css('top',Math.floor((pie.height-101)/2));
	jQuery('#messageControlBox').css('display','block');
	jQuery('#resendMessage').html('照相上传');
	jQuery('#deleteMessage').html('选择相册');
	Quo('#resendMessage').unbind('tap');
	Quo('#resendMessage').bind('tap',function(){
		pie.hideShadow();
		jQuery('#messageControlBox').css('display','none');
		jQuery('#resendMessage').html('重发');
		jQuery('#deleteMessage').html('删除');
		pie.getPicture(Camera.SAVEDPHOTOALBUM);
	});
	Quo('#deleteMessage').unbind('tap');
	Quo('#deleteMessage').bind('tap',function(){
		pie.hideShadow();
		jQuery('#messageControlBox').css('display','none');
		jQuery('#resendMessage').html('重发');
		jQuery('#deleteMessage').html('删除');
		pie.getPicture(Camera.PictureSourceType.PHOTOLIBRARY);
	});
	Quo('#pieShadow').unbind('tap');
	setTimeout(function(){
		Quo('#pieShadow').bind('tap',function(){
			Quo(this).unbind('tap');
			jQuery('#messageControlBox').css('display','none');
			pie.hideShadow();
		});
	},500);
}
jQuery('#doRegNow').css('display','none');
var socialText = "<div id='socialText'>请放心,我们不会随意触发任何新鲜事的~</div>";
jQuery('#socialLoginNav').append(socialText);
jQuery('#renrenLogo').bind('load',function(){
	jQuery(this).css('width','180px');
});
jQuery('#renrenLogo').attr('src','http://piemoment.com/m/img/renrenBig.png');
jQuery('#weiboLogo').css('height','37px');
jQuery('#weiboLogo').css('width','37px');
var sendButton = document.createElement('input');
sendButton.type = 'button';
sendButton.id = 'sendMessageButton';
sendButton.value = '发送';
document.getElementById('talkForm').appendChild(sendButton);
jQuery('#talkInput').css('width','70%');
Quo('#sendMessageButton').bind('tap',function(){
	pie.tcp.sendMessage();
});
Quo('#finishInfoButton').unbind('tap');
Quo('#finishInfoButton').bind('tap',function(){
	pie.showLeftMenu();
	setTimeout(function(){
		jQuery('.menuNavOuter').css('background-color','transparent');
      	jQuery('#menuUserHomeNav').css('background-color','#525252');
		setTimeout(function(){
			pie.showPage('userHomePage');
		},500);
	},500);
});
jQuery('#resetGetSmsArea').css('display','none');
var resetGetEmailAreaHTML = "<div id='resetGetEmailArea'><div class='formArea'>"
+"<div class='formTitle'>请输入您的邮箱申请重置密码</div><div class='formItem formInputItem'>"
+"<input type='text' placeholder='邮箱' class='itemInput' id='resetEmailInput'>"
+"</div></div><div class='formItem formInputItem'><input type='submit' class='itemSubmit'"
+"value='确认' id='resetEmailSubmit'></div></div>";
jQuery('#pieFindBackPasswordPage .scrollArea').append(resetGetEmailAreaHTML);
jQuery('#resetGetEmailArea').css('display','none');
var selectResetAreaHTML = "<div id='selectResetArea'><div id='resetBySmsButton' class='button'>通过手机号找回</div>"
+"<div id='resetByEmailButton' class='button'>通过邮箱找回</div></div>";
jQuery('#pieFindBackPasswordPage .scrollArea').append(selectResetAreaHTML);
jQuery('#resetBySmsButton').css('display','none');
Quo('#resetBySmsButton').bind('tap',function(){
	jQuery('#selectResetArea').css('display','none');
	jQuery('#resetGetSmsArea').css('display','block');
	Quo('#arrowBack').unbind('tap');
	Quo('#arrowBack').bind('tap',function(){
		jQuery('#selectResetArea').css('display','block');
		jQuery('#resetGetSmsArea').css('display','none');
		Quo('#arrowBack').unbind('tap');
		Quo('#arrowBack').bind('tap',function(){
			pie.pageBack();
		})
	})
});
Quo('#resetByEmailButton').bind('tap',function(){
	jQuery('#selectResetArea').css('display','none');
	jQuery('#resetGetEmailArea').css('display','block');
	Quo('#arrowBack').unbind('tap');
	Quo('#arrowBack').bind('tap',function(){
		jQuery('#selectResetArea').css('display','block');
		jQuery('#resetGetEmailArea').css('display','none');
		Quo('#arrowBack').unbind('tap');
		Quo('#arrowBack').bind('tap',function(){
			pie.pageBack();
		})
	})
});
Quo('#resetEmailSubmit').bind('tap',function(){
	var emailMode = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
	var email = jQuery('#resetEmailInput').val();
	if(!emailMode.test(email)){
		pie.remind('请输入正确的邮箱');
		jQuery('#resetEmailInput').focus();
		return;
	}
	var emailData = {
		'_format':'json',
		'app_token':'app_token',
		'userkey':email
	}
	pie.showLoading('正在发送邮件');
	jQuery.ajax({
		url:pie.serverBase+'/api/auth/account/reset/passwd/via/email',
		type:'get',
		data:emailData,
		dataType:'json',
		success:function(reply){
			pie.hideLoading();
			if(reply.status != 'success'){
				pie.remind('发送邮件失败，请报告管理员');
				return;
			}
			else{
				pie.remind('重置密码的邮件已经发送至您的邮箱:'+email+',请前往确认')
			}
		},
		error:function(err){
			pie.hideLoading();
			pie.remind('发送邮件失败:'+err+',这应该是网络问题造成的');
		}
	});
})
var inactivateHtml = "<div class='pieSettingNav' id='inactivateNav'><i class='icon-lock'></i><span>inactivate - 中止配对</span></div>";
jQuery('#feedBackNav').after(inactivateHtml);
Quo('#inactivateNav').bind('tap',function(){
	pie.confirm('您确认要中止配对吗？中止配对后当前的匹配信息都会被清空哦',function(){
		pie.inactivate();
	});
});
jQuery('.pieSettingNav').css('position','relative');
jQuery('.pieSettingNav span').css('position','absolute');
jQuery('.pieSettingNav span').css('left','35px');
pie.showPage = function(pageId){
	this.expand();
	if(this.curPageId == pageId){return;}
	jQuery('#'+this.curPageId+'Menu').css('display','none');
	jQuery('#'+pageId+'Menu').css('display','block');
	jQuery('#'+this.curPageId).css('display','none');
	if(pageId == 'pieMatchIndexPage'&&this.matchIndexReduce == true){
		this.enterMatchIndex();
		return;
	}
	jQuery('#'+pageId).css('display','block');
	switch(this.curPageId){
		case 'userShowImgPage':
		case 'mateShowImgPage':
		case 'pieGuidePage':
		this.swipePhoto = false;
		break;
	}
	this.curPageId = pageId;
	var topPage = false;
	switch(pageId){
		case 'userHomePage':
		topPage = true;
		jQuery('.menuNavOuter').css('background-color','transparent');
		jQuery('#menuUserHomeNav').css('background-color','#525252');
		break;
		case 'pieMatchIndexPage':
		topPage = true;
		jQuery('.menuNavOuter').css('background-color','transparent');
		jQuery('#menuPieMatchNav').css('background-color','#525252');
		break;
		case 'pieSettingPage':
		topPage = true;
		jQuery('.menuNavOuter').css('background-color','transparent');
		jQuery('#menuPieSettingNav').css('background-color','#525252');
		break;
		case 'pieTestIndexPage':
		topPage = true;
		jQuery('.menuNavOuter').css('background-color','transparent');
		jQuery('#menuPieTestNav').css('background-color','#525252');
		break;
		case 'mateTalkPage':
		pie.tcp.clearUnreadMessage();
		var bottomHeight = jQuery('#talkInputArea').prop('offsetHeight');
		jQuery('#talkRecordArea').css('height',this.height-bottomHeight-44);
		this.talkScrollArea.refresh();
		var talkRecord = pie.user.talkRecord;
		for(var i = 0; i < talkRecord.length; i++){
			if(talkRecord[i].status == pie.messageStatus.sendFailed){
				jQuery('#'+i+'userTalkBlock .userTalkContent').data('id',i);
				jQuery('#'+i+'userTalkBlock .userTalkContent').css('background-color','#555');
				Quo('.userTalkContent').unbind('hold');
				Quo('.userTalkContent').bind('hold',function(){
					var id = jQuery(this).data('id');
					if(!id||id < 0){return;}
					pie.tcp.showMessageControl(id);
				});
			}
		}
		break;
		case 'userShowImgPage':
		case 'mateShowImgPage':
		case 'pieGuidePage':
		pie.swipePhoto = true;
		break;
	}
	if(topPage){
		jQuery('#birdBack').css('display','block');
		jQuery('#arrowBack').css('display','none');
	}
	else{
		jQuery('#arrowBack').css('display','block');
		jQuery('#birdBack').css('display','none');
	}
	var curPage = pie.page[pageId];
	if(curPage.title){
		jQuery('#pieHeader').css('display','block');
		jQuery('#pageTitle').html(pie.page[pageId].title);
		jQuery('#'+pageId).css('height',pie.height-pie.headerHeight);
	}
	else{
		jQuery('#pieHeader').css('display','none');
		jQuery('#'+pageId).css('height',pie.height);
	}
	if(curPage.needScroll){
		if(!curPage.scrollArea){
			if(curPage.needRefresh){
				curPage.scrollArea = new iScroll(pageId,{
					useTransition:true,
					topOffset:50,
					hScroll:false,
					checkDOMChanges:false,
					onScrollMove: function () {
						if(this.y > 5 && pie.refreshReady){
							jQuery('#'+pie.curPageId+' .refreshIcon i').css('-webkit-transform','rotate(180deg)');
							jQuery('#'+pie.curPageId+' .refreshText').html('松开即可刷新');
							this.minScrollY = 0;
						}
						else if(this.y < 5 && !pie.refreshReady){
							pie.refreshReady = true;
							jQuery('#'+pie.curPageId+' .refreshText').html('下拉可以刷新');
							this.minScrollY = -50; 
						}
					},
					onScrollEnd: function () {
						if (pie.refreshReady) {
							jQuery('#'+pie.curPageId+' .refreshText').html('正在刷新');     
							pie.startRefresh();
						}
					}
				})
			}
			else{
				curPage.scrollArea = new iScroll(pageId,{
					useTransition:true,
					hScroll:false,
					checkDOMChanges:false
				})
			}
		}
		else{
			curPage.scrollArea.refresh();
		}
	}
	curPage.init(1);
}
pie.inactivate = function(){
	var inactiveData = {
      'token':this.user.data.access_token
    }
    this.showLoading('正在中止配对服务');
    jQuery.ajax({
      url:this.serverBase+'/api/rest/apps/pie_match/inactivate.json',
      type:'get',
      data:inactiveData,
      dataType:'json',
      success:function(reply){
        pie.hideLoading();
        if(reply.status != 'success'){
          if(reply.code == '2002'){
            pie.confirm('账号已过期,请重新登录',function(){
              pie.user.logout(0);
            },false)
          }
          else{
            pie.remind('中止配对服务失败,错误码:'+reply.code+'请报告管理员');
          }
          return;
        }
        pie.remind('您已经中止了配对服务');
        pie.showPage('pieMatchIndexPage');
        pie.page.pieMatchIndexPage.inited = false;
        pie.page.pieMatchIndexPage.init(1);
      },
      error:function(err){
        pie.hideLoading();
        pie.remind('中止配对服务失败:'+err+',这应该是网络问题造成的');
      }
    })
}
pie.activate = function(){
	var activeData = {
      'token':pie.user.data.access_token
    }
    pie.showLoading('正在激活');
    jQuery.ajax({
      url:pie.serverBase+'/api/rest/apps/pie_match/activate.json',
      type:'get',
      data:activeData,
      dataType:'json',
      success:function(reply){
        pie.hideLoading();
        if(reply.status != 'success'){
          if(reply.code == '2002'){
            pie.confirm('账号已过期,请重新登录',function(){
              pie.user.logout(0);
            },false)
          }
          else{
            pie.remind('激活账号失败,错误码:'+reply.code+'请报告管理员');
          }
          return;
        }
        jQuery('#activateButton').css('display','none');
        pie.page.pieMatchIndexPage.inited = false;
        pie.page.pieMatchIndexPage.init(1);
      },
      error:function(err){
        pie.hideLoading();
        pie.remind('激活账号失败:'+err+',这应该是网络问题造成的');
      }
    })
}
pie.npc.talk = function(message){
	pie.tcp.emitTalkToNpc(message);
	jQuery.post('http://www.xiaohuangji.com/ajax.php',{'para':message},function(pieWords){
		var unKnownReply = 
		['请问你在说什么鸟语?',
		'能说句我听得懂的吗?',
		'所以你是在考验我语义分析的能力吗?我听不懂啊',
		'你快别擦键盘了,说的我都听不懂啊',
		'饶了我吧~我真的不知道你在说什么',
		'再说一遍好吗?我刚没听明白'];
		if(pieWords == ''||pieWords.match('<a')){
			var rIndex = Math.floor(unKnownReply.length*Math.random());
			pieWords = unKnownReply[rIndex];
		}
		pieWords = pieWords.replace(/小黄鸡/g,'小Pie');
		pie.tcp.emitNpcReply(pieWords);
		if(pie.soundOn){
			pie.newMessageMedia.play();
		}
		var curTime = pie.tcp.judgeTime(pie.messageTime());
		var contentHtml = '<div class="mateTalkBlock" id="'+pie.user.talkRecord.length+'mateTalkBlock"><table><tbody><tr><td valign="top" width="15%"><div class="mateTalkHead" style="background-image:url('+pie.npc.smallHeadUrl+')"></div></td><td valign="top"><div class="mateTalkContent">'+pieWords+'</div><span class="messageTime">'+curTime+'</span></td></tr></tbody></table></div>';
		jQuery('#mateTalkPage .scrollArea').append(contentHtml);
		pie.talkScrollArea.refresh();
		var lastElem = document.getElementById(pie.user.talkRecord.length+'mateTalkBlock');
		pie.talkScrollArea.scrollToElement(lastElem,100);
		pie.user.talkRecord.push({
			'mid':10000*Math.random(),
			'from':pie.mate.info.puid,
			'to':pie.user.data.puid,
			'status':pie.messageStatus.inMessage,
			'content':pieWords,
			'contentType':0,
			'time':pie.messageTime()
		});
		pie.backup();
	});
}
pie.npc.init = function(){
	if(!pie.user.info){return;}
	if(!('sex' in pie.user.info)){return;}
	jQuery('#matchMateAvatar').unbind('load');
	jQuery('#matchMateAvatar').bind('load',function(){
		if(this.width>pie.width){
			this.width /= pie.dpi;
		}
		this.style.left = ''+(-1)*Math.floor((this.width-pie.width)/2)+'px';
	})
	var mateSex = 1;
	if(pie.user.info.sex == 1){
		mateSex = 0;
		this.headUrl = pie.femaleHeadUrl;
		this.smallHeadUrl = pie.smallFemaleHeadUrl;
		pie.mate.info = {
			puid:1234567,
			nickname:'小Pie',
			sex:mateSex,
			height:164,
			weight:50,
			current_location:'中国:北京市:海淀区',
			birthday:'1992-10-18',
			school:'北京大学',
			degree:'本科',
			birth_place:'中国:四川省:重庆市',
			presentation:'喵,天气真好～',
			occupation:'学生',
			domain:'外语',
			photos:[]
		};
		pie.mate.expectations = {
			'height_min':170,
			'height_max':180,
			'age_diff_min':0,
			'age_diff_max':3,
			'degree_min':'本科',
			'degree_max':'博士',
			'location_ideal':'中国:北京市:海淀区',
			'location_distance':'同省'
		};
		jQuery('#matchMateAvatar').attr('src',this.headUrl);
	}
	else{
		this.headUrl = pie.maleHeadUrl;
		this.smallHeadUrl = pie.smallMaleHeadUrl;
		pie.mate.info = {
			puid:7654321,
			nickname:'小Pie',
			sex:mateSex,
			height:175,
			weight:70,
			current_location:'中国:北京市:海淀区',
			birthday:'1992-03-13',
			school:'北京大学',
			degree:'本科',
			birth_place:'中国:湖北省:咸宁市',
			presentation:'今天阳光真好~',
			occupation:'学生',
			domain:'计算机',
			photos:[]
		};
		pie.mate.expectations = {
			'height_min':160,
			'height_max':180,
			'age_diff_min':-3,
			'age_diff_max':2,
			'degree_min':'本科',
			'degree_max':'博士',
			'location_ideal':'中国:北京市:海淀区',
			'location_distance':'同省'
		};
		jQuery('#matchMateAvatar').attr('src',this.headUrl);
	}
	pie.mate.info.photos.push({'uri':this.smallHeadUrl});
	pie.page.mateHomePage.refresh();
	if(pie.user.talkRecord.length > 0){
		if(pie.user.talkRecord[0].from != pie.mate.info.puid&&pie.user.talkRecord[0].to != pie.mate.info.puid){
			pie.user.talkRecord = [];
			jQuery('#mateTalkPage .scrollArea').html('');
			pie.backup();
		}
		pie.page.mateTalkPage.showRecord();
		return;
	}
	var pieWords = '你好,我是小Pie,很高兴认识你！';
	var curTime = pie.tcp.judgeTime(pie.messageTime());
	var contentHtml = '<div class="mateTalkBlock" id="'+pie.user.talkRecord.length+'mateTalkBlock"><table><tbody><tr><td valign="top" width="15%"><div class="mateTalkHead" style="background-image:url('+this.smallHeadUrl+')"></div></td><td valign="top"><div class="mateTalkContent">'+pieWords+'</div><span class="messageTime">'+curTime+'</span></td></tr></tbody></table></div>';
	jQuery('#mateTalkPage .scrollArea').append(contentHtml);
	pie.talkScrollArea.refresh();
	var lastElem = document.getElementById(pie.user.talkRecord.length+'mateTalkBlock');
	pie.talkScrollArea.scrollToElement(lastElem,100);
	pie.user.talkRecord.push({
		'mid':10000*Math.random(),
		'from':pie.mate.info.puid,
		'to':pie.user.data.puid,
		'status':pie.messageStatus.inMessage,
		'content':pieWords,
		'contentType':0,
		'time':pie.messageTime()
	});
	pie.backup();
}
pie.page.pieMatchIndexPage.refresh = function(){
	var reply = pie.user.matchReply;
	if(reply.status != 'success'){
		jQuery('#matchStatus').css('display','block');
		if(pie.studyStart){
			jQuery('#pieMatchIndexPageMenu').html('体验中');
		}
		else{
			jQuery('#pieMatchIndexPageMenu').html('体验一下');
		}
		switch(reply.message){
			case 'inactive':
			jQuery('#matchStatusText').html('您的账号目前不能参与配对,请点击此处激活');
			jQuery('#activateButton').css('display','block');
			jQuery('#statusTime').css('display','none');
			break;
			case 'not_matched': 
			jQuery('#matchStatusText').html('本着宁缺毋滥的原则,今日没有为你找到合适的配对,距下次配对:');
			jQuery('#statusTime').css('display','block');
			break;
			case 'ready_for_match':
			jQuery('#matchStatusText').html('每天中午12点为你匹配一位Ta,距下次配对:');
			jQuery('#statusTime').css('display','block');
			break;
		}
		pie.mate.exist = false;
		pie.npc.init();
		return;
	}
	jQuery('#pieMatchIndexPageMenu').html('');
	jQuery('#matchStatus').css('display','none');
	pie.user.matchType = reply.data.type;
	if(reply.data.type == 1){
		if(!('followers_info' in reply.data.data[0])){
			jQuery('#statusText').html('请耐心等待有缘人:');
			jQuery('#matchControlBox').css('display','none');
			return;
		}
		pie.aladdin.info = reply.data.data[0];
		pie.aladdin.personInfo = reply.data.data[0].followers_info;
		pie.aladdin.personExpecation = reply.data.data[0].followers_expectation;
		pie.aladdin.init(1);
		switch(pie.aladdin.info.aladdin_status){
			case 'successful aladdin':
			jQuery('#pieMatchType').css('display','none');
			jQuery('#statusText').html('配对成功,加油!');
			jQuery('#matchControlLeftButton i').removeClass('icon-remove');
			jQuery('#matchControlLeftButton i').addClass('icon-refresh');
			jQuery('#matchControlRightButton i').removeClass('icon-heart');
			jQuery('#matchControlRightButton i').addClass('icon-comment');
			jQuery('#matchControlRightButton').css('background-color','rgb(8, 143, 148)');
			break;
			case 'not decided yet':
			jQuery('#statusText').html('请尽快做出选择:');
			jQuery('#matchControlLeftButton i').removeClass('icon-refresh');
			jQuery('#matchControlLeftButton i').addClass('icon-remove');
			jQuery('#matchControlRightButton i').removeClass('icon-comment');
			jQuery('#matchControlRightButton i').addClass('icon-heart');
			break;
			case 'failed match':
			jQuery('#statusText').html('配对失败,下次配对只剩');
			pie.mate.exist = false;
			pie.npc.init();
			break;
			case 'break up match':
			jQuery('#statusText').html('配对被取消,下次配对只剩');
			pie.mate.exist = false;
			pie.npc.init();
			break;
			default:pie.remind('what?'+pie.user.matchInfo.match_status);
			break;
		}
		return;
	}
	if(reply.data.data.length > 0){
		pie.mate.exist = true;
		pie.user.matchInfo = reply.data.data[0];
		pie.mate.info = reply.data.data[0].target_info;
		if(pie.mate.info.puid != pie.user.curMate){
			pie.mate.changed = true;
		}
		pie.user.curMate = pie.mate.info.puid;
		if(pie.user.talkRecord){
			pie.page.mateTalkPage.showRecord();
		}
		pie.mate.expectations = reply.data.data[0].target_expectation;
		pie.mate.init();
		pie.backup();
		switch(pie.user.matchInfo.match_status){
			case 'successful aladdin':
			case 'successful match':
			jQuery('#matchControlBox').css('display','block');
			jQuery('#mateDecisionBox').css('font-size','20px');
			jQuery('#mateDecisionBox').css('top','23px');
			jQuery('#mateDecisionText i').removeClass('icon-ok');
			jQuery('#mateDecisionText i').addClass('icon-heart');
			jQuery('#mateDecisionText i').css('display','inline');
			jQuery('#mateDecisionText span').html('配对成功');
			jQuery('#countDownClock').css('display','none');
			jQuery('#leftButtonIcon i').removeClass('icon-heart');
			jQuery('#leftButtonIcon i').addClass('icon-comment');
			jQuery('#leftButtonText').html('talk');
			jQuery('#matchControlLeftButton').css('background-color','rgb(8, 143, 148)');
			jQuery('#rightButtonIcon i').removeClass('icon-play');
			jQuery('#rightButtonIcon i').addClass('icon-refresh');
			jQuery('#rightButtonText').html('break');
			break;
			case 'not decided yet':
			jQuery('#mateDecisionText i').css('display','none');
			switch(pie.user.matchInfo.my_decision){
				case 'like':
				jQuery('#mateDecisionText span').html('你已选择like');
				jQuery('#matchControlBox').css('display','none');
				break;
				case 'pass':
				jQuery('#mateDecisionText span').html('你已选择pass');
				jQuery('#matchControlBox').css('display','none');
				break;
				case 'unknown':
				jQuery('#matchControlBox').css('display','block');
				switch(pie.user.matchInfo.target_decision){
					case 'unknown':
					jQuery('#mateDecisionText span').html('请快选择');
					break;
					case 'decision_made':
					jQuery('#mateDecisionText i').removeClass('icon-heart');
					jQuery('#mateDecisionText i').addClass('icon-ok');
					jQuery('#mateDecisionText i').css('display','inline');
					if(pie.mate.info.sex == 0){
						jQuery('#mateDecisionText span').html('她已选择');
					}
					else{
						jQuery('#mateDecisionText span').html('他已选择');
					}
					break;
				}
				break;
				default:break;
			}
			break;
			case 'failed aladdin':
			case 'failed match':
			jQuery('#mateDecisionText i').css('display','none');
			switch(pie.user.matchInfo.my_decision){
				case 'unknown':
				if(pie.mate.info.sex == 0){
					jQuery('#mateDecisionText span').html('她已选择');
				}
				else{
					jQuery('#mateDecisionText span').html('他已选择');
				}
				jQuery('#mateDecisionText i').removeClass('icon-heart');
				jQuery('#mateDecisionText i').addClass('icon-ok');
				jQuery('#mateDecisionText i').css('display','inline');
				jQuery('#matchControlBox').css('display','block');
				break;
				case 'like':
				jQuery('#mateDecisionText span').html('配对失败');
				jQuery('#matchControlBox').css('display','none');
				pie.mate.exist = false;
				break;
				case 'pass':
				jQuery('#mateDecisionText span').html('你已选择pass');
				jQuery('#matchControlBox').css('display','none');
				break;
			}
			break;
			case 'break up match':
			jQuery('#mateDecisionText span').html('配对失败');
			jQuery('#mateDecisionText i').css('display','none');
			jQuery('#matchControlBox').css('display','none');
			pie.mate.exist = false;
			break;
			default:pie.remind('what?'+pie.user.matchInfo.match_status);
			break;
		}
	}
}
var pt = pie.tcp;
pt.emitNextMessage = function(){
	var next = pie.user.nextMessageIndex;
	var talkRecord = pie.user.talkRecord;
	while(next<talkRecord.length&&(talkRecord[next].from != pie.user.data.puid||talkRecord[next].status == pie.messageStatus.deleted)){
		next++;
	}
	pie.user.nextMessageIndex = next;
	pie.backup();
	if(next>=talkRecord.length){return;}
	if(pie.user.messageSended){
		pie.user.messageSended = false;
		this.handle.emit('pieTalk',{
			'targetId':pie.mate.info.puid,
			'content':talkRecord[next].content,
			'contentType':talkRecord[next].contentType,
			'nickname':pie.user.info.nickname,
			'puid':pie.user.data.puid,
			'access_token':pie.user.data.access_token
		});
		this.checkSend = setTimeout(function(){
			pie.tcp.emitFailed();
		},30000);
		pie.backup();
	}
}
pt.emitTalkToNpc = function(message){
	if(!this.handle){return;}
	this.handle.emit('talkToNpc',{
		'content':message
	});
}
pt.emitNpcReply = function(message){
	if(!this.handle){return;}
	this.handle.emit('npcReply',{
		'content':message
	});
}
pt.emitReport = function(message,target){
	if(!this.handle){return;}
	if(target == null){
		target = '产品';
	}
	this.handle.emit('pieReport',{'acc':pie.user.data.access_token,'content':message,'target':target,'platform':pie.platform});
}
var allPage = pie.page;
var newShowReport = function(){
	var newTestReport = "恭喜您已经完成了测试,我们将会根据您的测试结果为你匹配更适合的对象!";
	jQuery('#'+this.id+' .testChoices').css('display','none');
	jQuery('#'+this.id+' .testQuestion').css('display','none');
	jQuery('#'+this.id+' .testReport').css('display','block');
	jQuery('#'+this.id+' .testTitle').html('谢谢!');
	jQuery('#'+this.id+' .testReport').html(newTestReport);
	if(this.scrollArea){
		this.scrollArea.refresh();
	}
	pie.user.seeLoveReport = null;
	pie.user.seeLifeReport = null;
	pie.user.personalityReport = null;
	pie.user.communicationReport = null;
	pie.backup();
}
allPage.userSeeLoveTestPage.showReport = newShowReport;
allPage.userSeeLifeTestPage.showReport = newShowReport;
allPage.userPersonalityTestPage.showReport = newShowReport;
allPage.userCommunicationTestPage.showReport = newShowReport;
if(pie.user.seeLoveReport){
	allPage.userSeeLoveTestPage.showReport();
}
if(pie.user.seeLifeReport){
	allPage.userSeeLifeTestPage.showReport();
}
if(pie.user.personalityReport){
	allPage.userPersonalityTestPage.showReport();
}
if(pie.user.communicationReport){
	allPage.userCommunicationTestPage.showReport();
}
allPage.pieReportPage.submit = function(){
	var content = jQuery('#reportInput textarea').val();
	if(content == ''){return;}
	jQuery('#reportInput textarea').val('');
	pie.showLoading('正在提交');
	if(this.reportType == 1){
		var reportData = {
			'token':pie.user.data.access_token,
			'content':content,
			'type':this.reportType,
			'platform':pie.platform,
			'to_user':pie.mate.info.nickname
		}
		pie.tcp.emitReport(content,pie.mate.info.nickname);
		jQuery.ajax({
			url:pie.serverBase+'/api/rest/report/report.json',
			type:'post',
			data:reportData,
			dataType:'json',
			success:function(reply){
				pie.hideLoading();
				if(reply.status == 'success'){
					pie.remind('举报用户'+pie.mate.info.nickname+'成功,我们将尽快做出处理');
				}
			},
			error:function(err){
				pie.hideLoading();
				pie.remind('提交出错:'+err+',这应该是网络问题造成的');
			}
		})
	}
	else{
		var reportData = {
			'token':pie.user.data.access_token,
			'content':content,
			'type':this.reportType,
			'platform':pie.platform
		}
		pie.tcp.emitReport(content);
		jQuery.ajax({
			url:pie.serverBase+'/api/rest/report/report.json',
			type:'post',
			data:reportData,
			dataType:'json',
			success:function(reply){
				pie.hideLoading();
				if(reply.status == 'success'){
					pie.remind('提交反馈成功,谢谢您的配合~')
				}
			},
			error:function(err){
				pie.hideLoading();
				pie.remind('提交出错:'+err+',这应该是网络问题造成的');
			}
		})
	}
}
allPage.mateHomePage.photoInit = function(){
	if(!pie.mate.exist){
		jQuery('#mateHomeAvatar').attr('src',pie.npc.smallHeadUrl);
		this.curAvatar = pie.npc.smallHeadUrl;
	}
	else if('avatar' in pie.mate.info){
		var avatarChanged = false;
		if(pie.mate.changed){
			avatarChanged = true;
		}
		else{
			avatarChanged = (this.curAvatar != null&&this.curAvatar != pie.mate.info.avatar.uri);
		}
		pie.mate.changed = false;
		this.curAvatar = pie.mate.info.avatar.uri;
		if(!this.bigPhotoInited||avatarChanged){
			var matchMateAvatar = document.getElementById('matchMateAvatar');
			jQuery('#matchMateAvatar').unbind('load');
			jQuery('#matchMateAvatar').load(function(){
				if(this.width>pie.width){
					this.width /= pie.dpi;
				}
				this.style.left = ''+(-1)*Math.floor((this.width-pie.width)/2)+'px';
			});
			matchMateAvatar.src = pie.serverBase+'/asset/'+pie.mate.info.avatar.uri+'/'+pie.width*pie.dpi+'/'+(pie.height-pie.headerHeight)*pie.dpi+'/smart/inline';
		}
		this.bigPhotoInited = true;

		var talkHeadSize = 40*pie.dpi;
		if(pie.canvasExist&&(!pie.user.mateTalkAvatar||avatarChanged)){
			var mateTalkAvatar = document.createElement('img');
			mateTalkAvatar.addEventListener('load',function(){
				var canvas = document.createElement('canvas');
				var ctx = canvas.getContext('2d');
				canvas.width = this.width;
				canvas.height = this.height;
				ctx.drawImage(this,0,0,this.width,this.height);
				pie.user.mateTalkAvatar = canvas.toDataURL("image/png");
				canvas = null;
				pie.backup();
			})
			mateTalkAvatar.src = pie.serverBase+'/asset/'+pie.mate.info.avatar.uri+'/'+talkHeadSize+'/'+talkHeadSize+'/smart/inline';
		}

		var homeHeadSize=(Math.floor(pie.width*0.3)-6)*pie.dpi;
		var mateHomeAvatar = document.getElementById('mateHomeAvatar');
		mateHomeAvatar.src = pie.serverBase+'/asset/'+pie.mate.info.avatar.uri+'/'+homeHeadSize+'/'+homeHeadSize+'/smart/inline';
	}
	if(!('photos' in pie.mate.info)){return;}
	var theSame = true;
	if(this.curPhotos&&this.curPhotos.length == pie.mate.info.photos.length){
		for(var i = 0; i < this.curPhotos.length; i++){
			if(this.curPhotos[i] != pie.mate.info.photos[i].uri){
				theSame = false;
				break;
			}
		}
	}
	else{
		theSame = false;
	}
	if(theSame){return;}
	this.curPhotos = [];
	for(var i = 0; i < pie.mate.info.photos.length; i++){
		this.curPhotos[i] = pie.mate.info.photos[i].uri;
	}
	var smallPhotoHtml = '';
	var bigPhotoHtml = '';
	var imgFooterHtml = '';
	var len = pie.mate.info.photos.length;
	var smallPhotoNum = Math.min(len,Math.floor(pie.width*0.9/52));
	var min = Math.max(0,len-smallPhotoNum);
	for(var i = len-1; i >= min; i--){
		smallPhotoHtml += '<div class="mateHomePhoto"><img id="'+i+'mateSmallPhoto"/></div>'
	}
	jQuery('#matePhotoBlock').html(smallPhotoHtml);
	Quo('.mateHomePhoto').unbind('tap');
	Quo('.mateHomePhoto').bind('tap',function(){
		var len = pie.mate.info.photos.length;
		var i = len-1-jQuery(this).index();
		pie.mate.showImg(i);
	});
	for(var i = len-1; i >= min; i--){
		var curImg = document.getElementById(i+'mateSmallPhoto');
		if(pie.mate.exist){
			curImg.src = pie.serverBase+'/asset/'+pie.mate.info.photos[i].uri+'/'+48*pie.dpi+'/'+48*pie.dpi+'/smart/inline';
		}
		else{
			curImg.src = pie.mate.info.photos[i].uri;
		}
	}
	for(var i = len-1; i >= 0; i--){
		bigPhotoHtml += '<div class="swipeItem"><img id="'+i+'mateBigPhoto" class="mateBigPhoto"/></div>';
		imgFooterHtml += '<i class="icon-circle swipeNav" id="'+(len-1-i)+'mateImgNav"></i>';
	}
	jQuery('#mateShowImgPage .swipe-wrap').html(bigPhotoHtml);
	jQuery('#mateShowImgPage .swipeFooter').html(imgFooterHtml);
	Quo('#mateShowImgPage .swipeNav').unbind('tap');
	Quo('#mateShowImgPage .swipeNav').bind('tap',function(){
		var e = event||window.event;
		e.stopPropagation();
		var id = parseInt(this.id);
		window.mateSwipe.slide(id,500)
	});
	jQuery('#0mateImgNav').css('color','#555');
	var elem = document.getElementById('mateImgSwipe');
	window.mateSwipe = Swipe(elem, {
		startSlide:0,
		continuous:false,
		disableScroll:true,
		stopPropagation:false,
		callback: function(index, element){
			index %= pie.mate.info.photos.length;
			pie.mate.curImgIndex = pie.mate.info.photos.length-index-1;
			var curImg = document.getElementById(pie.mate.curImgIndex+'mateBigPhoto');
			if(!curImg.src){
				pie.showLoading('正在加载');
				curImg.addEventListener('load',function(){
					this.width /= pie.dpi;
					this.style.left = (pie.width-this.width)/2+'px';
					this.style.top = (pie.height-this.height)/2+'px';
					pie.hideLoading();
				});
				if(pie.mate.exist){
					curImg.src = pie.serverBase+'/asset/'+pie.mate.info.photos[pie.mate.curImgIndex].uri+'/'+pie.width*pie.dpi+'/'+pie.height*pie.dpi+'/inner/inline';
				}
				else{
					curImg.src = pie.mate.info.photos[pie.mate.curImgIndex].uri;
				}

			}
			jQuery('#mateShowImgPage .swipeNav').css('color','#eee');
			jQuery('#'+index+'mateImgNav').css('color','#555');
		},
		transitionEnd: function(index, element){}
	});
}
allPage.mateHomePage.initAnswer = function(){
	if(pie.mate.answers.length<=0){return;}
	jQuery('#mateNoQA').css('display','none');
	jQuery('#mateQABlock').css('display','block');
	this.curAnswerIndex = pie.user.mateAnswerIndex;
	if(this.curAnswerIndex<0||this.curAnswerIndex>=pie.mate.answers.length){
		this.curAnswerIndex = 0;
	}
	this.showAnswer();
}
var uip = allPage.userInputPage;
uip.showInput = function(id){
	jQuery('#userInputPage').css('display','block');
	jQuery('.inputArea').css('display','none');
	jQuery('#'+id+'Area').css('display','block');
	var ss = pie.select;
	switch(id){
		case 'userInfoMobile':
		this.title = '请输入绑定手机';
		this.inputType = 0;
		break;
		case 'userInfoNickname':
		this.title = '昵称';
		this.inputType = 1;
		break;
		case 'userInfoPresentation':
		this.title = '自我介绍';
		this.inputType = 2;
		break;
		case 'userInfoRealname':
		this.title = '真实姓名';
		this.inputType = 3;
		break;
		case 'userInfoHeight':
		this.title = '身高';
		this.inputType = 4;
		ss.init('userInfoHeightInput');
		break;
		case 'userInfoWeight':
		this.title = '体重';
		this.inputType = 5;
		ss.init('userInfoWeightInput');
		break;
		case 'userInfoBirthday':
		this.title = '生日';
		this.inputType = 6;
		ss.init('userInfoBirthdayYearInput');
		ss.init('userInfoBirthdayMonthInput');
		ss.init('userInfoBirthdayDayInput');
		break;
		case 'userInfoCurrentLocation':
		this.title = '现居地';
		this.inputType = 7;
		ss.init('userInfoCurrentLocationProvinceInput');
		ss.init('userInfoCurrentLocationCityInput');
		break;
		case 'userInfoBirthPlace':
		this.title = '籍贯';
		this.inputType = 8;
		ss.init('userInfoBirthPlaceProvinceInput');
		ss.init('userInfoBirthPlaceCityInput');
		break;
		case 'userInfoSchool':
		this.title = '学校';
		this.inputType = 9;
		ss.init('schoolProvinceInput');
		ss.init('userInfoSchoolInput');
		break;
		case 'userInfoDegree':
		this.title = '学历';
		this.inputType = 10;
		ss.init('userInfoDegreeInput');
		break;
		case 'userInfoOccupation':
		this.title = '职业';
		this.inputType = 11;
		ss.init('userInfoOccupationInput');
		ss.init('userInfoDomainInput');
		break;
		case 'userExpectationHeight':
		this.title = '身高要求';
		this.inputType = 12;
		ss.init('userExpectationMinHeightInput');
		ss.init('userExpectationMaxHeightInput');
		break;
		case 'userExpectationAge':
		this.title = '年龄要求';
		this.inputType = 13;
		ss.init('userExpectationMinAgeInput');
		ss.init('userExpectationMaxAgeInput');
		break;
		case 'userExpectationDegree':
		this.title = '学历要求';
		this.inputType = 14;
		ss.init('userExpectationMinDegreeInput');
		ss.init('userExpectationMaxDegreeInput');
		break;
		case 'userExpectationIdealLocation':
		this.title = '理想城市';
		this.inputType = 15;
		ss.init('userExpectationIdealLocationProvinceInput');
		ss.init('userExpectationIdealLocationCityInput');
		break;
		case 'userExpectationLocationDistance':
		this.title = '距离要求';
		this.inputType = 16;
		ss.init('userExpectationLocationDistanceInput');
		break;
		case 'userInfoPhotos':
		this.title = '请上传两张真实照片';
		this.inputType = 17;
		break;
		default:this.title = '未知情况';break;
	}
	jQuery('#inputTitle').html(this.title);
	setTimeout(function(){
		jQuery('#userInputPage').css('-webkit-transform','translate3d('+pie.width+'px,0,0)');
	},0);
}
uip.updatePresentation = function(){
	var newData = jQuery('#userInfoPresentationInput').val();
	if(newData == ''){
		pie.remind('自我介绍不能为空');
		return;
	}
	var userInfoData = {
		'token':pie.user.data.access_token,
		'presentation':newData
	}
	this.updateUserInfo(userInfoData);
}
uip.updateNickname = function(){
	var newNickname = jQuery('#userInfoNicknameInput').val();
	if(newNickname == ''){
		pie.remind('昵称不能为空');
		return;
	}
	var nicknameData = {
		'token':pie.user.data.access_token,
		'nickname':newNickname
	}
	pie.showLoading('正在检测昵称是否重复')
	jQuery.ajax({
		'url':pie.serverBase+'/api/rest/user/nickname.json',
		'type':'put',
		'data':nicknameData,
		'dataType':'json',
		success:function(reply){
			pie.hideLoading();
			if(reply.status == 'success'){
				pie.remind('修改昵称成功');
				jQuery('#userInputPage').css('-webkit-transform','translate3d(0,0,0)');
				setTimeout(function(){
					jQuery('#userInputPage').css('display','none');
				},300);
				pie.user.getInfo(0);
			}
			else{
				pie.confirm('很遗憾,昵称已被使用...请重新选择',function(){
					jQuery('#userInfoNicknameInput').val('');
					jQuery('#userInfoNicknameInput').focus();
				})
			}
		},
		error:function(err){
			pie.hideLoading();
			pie.remind('修改昵称碰到未知错误:'+err+',这应该是网络问题造成的');
		}
	});
}
uip.updateRealname = function(){
	var newData = jQuery('#userInfoRealnameInput').val();
	if(newData == ''){
		pie.remind('真实姓名不能为空');
		return;
	}
	var userInfoData = {
		'token':pie.user.data.access_token,
		'realname':newData
	}
	this.updateUserInfo(userInfoData);
}
uip.updateHeight = function(){
	var ss = pie.select;
	var newData = ss.getValue('userInfoHeightInput');
	var userInfoData = {
		'token':pie.user.data.access_token,
		'height':newData
	}
	this.updateUserInfo(userInfoData);
}
uip.updateWeight = function(){
	var ss = pie.select;
	var newData = ss.getValue('userInfoWeightInput');
	var userInfoData = {
		'token':pie.user.data.access_token,
		'weight':newData
	}
	this.updateUserInfo(userInfoData);
}
uip.updateBirthday = function(){
	var ss = pie.select;
	var birthdayYear = parseInt(ss.getValue('userInfoBirthdayYearInput'));
	var birthdayMonth = parseInt(ss.getValue('userInfoBirthdayMonthInput'));
	var birthdayDay = parseInt(ss.getValue('userInfoBirthdayDayInput'));
	if(birthdayMonth<10){
		birthdayMonth = '0'+birthdayMonth;
	}
	if(birthdayDay<10){
		birthdayDay = '0'+birthdayDay;
	}
	var newData = birthdayYear+'-'+birthdayMonth+'-'+birthdayDay;
	var userInfoData = {
		'token':pie.user.data.access_token,
		'birthday':newData
	}
	this.updateUserInfo(userInfoData);
}
uip.updateCurrentLocation = function(){
    var ss = pie.select;
	var newData = '中国:'+ss.getValue('userInfoCurrentLocationProvinceInput')
        +':'+ss.getValue('userInfoCurrentLocationCityInput');
	var userInfoData = {
		'token':pie.user.data.access_token,
		'current_location':newData
	}
	this.updateUserInfo(userInfoData);
}
uip.updateBirthPlace = function(){
	var ss = pie.select;
	var newData = '中国:'+ss.getValue('userInfoBirthPlaceProvinceInput')
        +':'+ss.getValue('userInfoBirthPlaceCityInput');
	var userInfoData = {
		'token':pie.user.data.access_token,
		'birth_place':newData
	}
	this.updateUserInfo(userInfoData);
}
uip.updateSchool = function(){
	var ss = pie.select;
	var newData = ss.getValue('userInfoSchoolInput');
	var userInfoData = {
		'token':pie.user.data.access_token,
		'school':newData
	}
	this.updateUserInfo(userInfoData);
}
uip.updateDegree = function(){
	var ss = pie.select;
	var newData = ss.getValue('userInfoDegreeInput');
	var userInfoData = {
		'token':pie.user.data.access_token,
		'degree':newData
	}
	this.updateUserInfo(userInfoData);
}
uip.updateOccupation = function(){
	var ss = pie.select;
	var occupationIndex = ss.getValue('userInfoOccupationInput');
    var occupation = pie.occupationList[occupationIndex];
    var domainIndex = ss.getValue('userInfoDomainInput');
    var domain = pie.domainList[occupationIndex][domainIndex];
	var userInfoData = {
		'token':pie.user.data.access_token,
		'occupation':occupation,
		'domain':domain
	}
	this.updateUserInfo(userInfoData);
}
uip.updateExpectationHeight = function(){
	var ss = pie.select;
	var height_min = ss.getValue('userExpectationMinHeightInput');
	var height_max = ss.getValue('userExpectationMaxHeightInput');
	var userInfoData = {
		'token':pie.user.data.access_token,
		'height_min':height_min,
		'height_max':height_max
	}
	this.updateUserExpectation(userInfoData);
}
uip.updateExpectationAge = function(){
	var ss = pie.select;
	var age_diff_min = ss.getValue('userExpectationMinAgeInput');
    var age_diff_max = ss.getValue('userExpectationMaxAgeInput');
	var userInfoData = {
		'token':pie.user.data.access_token,
		'age_diff_min':age_diff_min,
        'age_diff_max':age_diff_max
	}
	this.updateUserExpectation(userInfoData);
}
uip.updateExpectationDegree = function(){
	var ss = pie.select;
	var degree_min = pie.degreeList[ss.getValue('userExpectationMinDegreeInput')];
    var degree_max = pie.degreeList[ss.getValue('userExpectationMaxDegreeInput')];
    var userInfoData = {
		'token':pie.user.data.access_token,
		'degree_min':degree_min,
        'degree_max':degree_max
	}
	this.updateUserExpectation(userInfoData);
}
uip.updateIdealLocation = function(){
	var ss = pie.select;
	var location_ideal = '中国:'+ss.getValue('userExpectationIdealLocationProvinceInput')
        +':'+ss.getValue('userExpectationIdealLocationCityInput');
    var userInfoData = {
		'token':pie.user.data.access_token,
		'location_ideal':location_ideal
	}
	this.updateUserExpectation(userInfoData);
}
uip.updateLocationDistance = function(){
	var ss = pie.select;
	var location_distance = ss.getValue('userExpectationLocationDistanceInput');
    var userInfoData = {
		'token':pie.user.data.access_token,
		'location_distance':location_distance
	}
	this.updateUserExpectation(userInfoData);
}
uip.updateUserInfo = function(userInfoData){
	pie.showLoading('正在提交信息');
	jQuery.ajax({
		url:pie.serverBase+'/api/rest/users/'+pie.user.data.puid+'.json',
		type:'put',
		data:userInfoData,
		dataType:'json',
		success:function(reply){
			pie.hideLoading();
			if(reply.status != 'success'){
				if(reply.code == '2002'){
					pie.confirm('账号已过期,请重新登录',function(){
						pie.user.logout(0);
					});
				}
				else{
					pie.remind('提交信息出现未知错误,错误码:'+reply.code+',请报告管理员');
				}
			}
			else{
				if(!pie.atTheFirst){
					pie.remind('更新信息成功');
					jQuery('#userInputPage').css('-webkit-transform','translate3d(0,0,0)');
					setTimeout(function(){
						jQuery('#userInputPage').css('display','none');
					},300);
				}
				pie.user.getInfo(0);
			}
		},
		error:function(err){
			pie.hideLoading();
			pie.remind('提交用户基本信息出错:'+err+',这应该是网络问题造成的');
		}
	})
}
uip.updateUserExpectation = function(userInfoData){
	pie.showLoading('正在更新');
	jQuery.ajax({
		url:pie.serverBase+'/api/rest/apps/pie_match/expectations.json',
		type:'put',
		data:userInfoData,
		dataType:'json',
		success:function(reply){
			pie.hideLoading();
			if(reply.status != 'success'){
				if(reply.code == '2002'){
					pie.confirm('账号已过期,请重新登录',function(){
						pie.user.logout(0);
					},false)
				}
				else{
					pie.remind('提交期望出现未知错误,错误码:'+reply.code+',请报告管理员');
				}
			}
			else{
				if(!pie.atTheFirst){
					pie.remind('更新配对要求成功');
					jQuery('#userInputPage').css('-webkit-transform','translate3d(0,0,0)');
					setTimeout(function(){
						jQuery('#userInputPage').css('display','none');
					},300);
				}
				pie.user.getInfo(0);
			}
		},
		error:function(err){
			pie.hideLoading();
			pie.remind('提交用户期望信息出错:'+err+',这应该是网络问题造成的');
		}
	})
}
uip.submit = function(){
	if(pie.curInputId){
		jQuery('#'+pie.curInputId).blur();
	}
	switch(this.inputType){
		case -1:this.codeSubmit();break;
		case 0:this.getSms();break;
		case 1:this.updateNickname();break;
		case 2:this.updatePresentation();break;
		case 3:this.updateRealname();break;
		case 4:this.updateHeight();break;
		case 5:this.updateWeight();break;
		case 6:this.updateBirthday();break;
		case 7:this.updateCurrentLocation();break;
		case 8:this.updateBirthPlace();break;
		case 9:this.updateSchool();break;
		case 10:this.updateDegree();break;
		case 11:this.updateOccupation();break;
		case 12:this.updateExpectationHeight();break;
		case 13:this.updateExpectationAge();break;
		case 14:this.updateExpectationDegree();break;
		case 15:this.updateIdealLocation();break;
		case 16:this.updateLocationDistance();break;
	}
}
var remoteCss = document.createElement('style');
remoteCss.innerHTML = "#sendMessageButton{width:20%;height:30px;border:none;background-color:"
+"#eee;border-radius:15px;margin-left:1%;position:relative;top:-6px;box-shadow:0px 2px #bbb;}"
+"#sendMessageButton:active{top:-4px;box-shadow:none;}"
+"#selectResetArea .button{background:#ea4c89;border:1px solid #ccc;border-radius:4px;width:80%;"
+"height:50px;line-height:50px;color:#fff;text-align:center;margin:auto;outline: none;margin-bottom:20px;}"
+"#socialText{position:absolute;top:-20px;font-size:12px;color:#eee;}"
+"#newInputSubmit{display:none;width:85%;margin:auto;margin-top:20px;text-align:center;color:#fff;border-radius:5px;padding:15px 0px;background-color:#ea4c89;}"
+"#userInfoPhotosArea{text-align:center;}#firstUploadPhotoButton{display:inline-block;position:relative;width:80px;height:80px;background-color:#cfcacc;border-radius:40px;color:#fff}"
+"#firstUploadPhotoForm{position:absolute;z-index:10;width:100%;height:100%;opacity:0;}"
+"#firstFormFile{position:absolute;width:100%;height:100%;left:0px;top:0px;padding:0px;}#firstUploadPhotoButton i{position:absolute;font-size:40px;z-index:5;top:20px;left:20px;}"
+"#firstPhotoArea{display:inline-block;text-align:left;}.firstPhoto{float:left;}#firstPhotoArea img{width:80px;height:80px;border-radius:45px;margin-left:10px;}#userInputPage{z-index:10;}";
document.body.appendChild(remoteCss);
var newInputSubmitHtml = "<div id='newInputSubmit'>下一步</div>";
jQuery('#userInputPage .paddingArea').append(newInputSubmitHtml);
Quo('#newInputSubmit').bind('tap',function(){
	pie.page.userInputPage.submit();
});
var uploadPhotoHtml = "<div id='userInfoPhotosArea' class='inputArea'><div id='firstUploadPhotoButton'><i class='icon-camera-retro'></i>"
+"<form id='firstUploadPhotoForm'><input type='file' id='firstFormFile' name='file'/>"
+"<input type='hidden' id='firstAccess_token' name='token'/></form></div><div id='firstPhotoArea'></div></div>";
jQuery('#userInfoMobileArea').before(uploadPhotoHtml);
jQuery('#firstPhotoArea').css('width',pie.width*0.85-90);
jQuery('#firstFormFile').bind('change',function(){
	var imageMode = /^[\s\S]+(.JPEG|.jpeg|.JPG|.jpg|.GIF|.gif|.BMP|.bmp|.PNG|.png)$/;
	if(!imageMode.test(this.files[0].name)){
		pie.remind('请上传png,jpg,peg,gif,bmp格式的图像');
		return;
	}
	jQuery('#firstAccess_token').val(pie.user.data.access_token);
	var form = document.getElementById('firstUploadPhotoForm');
	var action = pie.serverBase+'/api/rest/users/'+pie.user.data.puid+'/photos.json';
	var xhr = new XMLHttpRequest();
	pie.showLoading('正在上传头像');
	xhr.onreadystatechange = function(){
		if(xhr.readyState == 4){
			if(xhr.status == 200){
				pie.hideLoading();
				var reply = jQuery.parseJSON(xhr.responseText);
				if(reply.status == 'success'){
					pie.user.getInfo(0);
				}
				else{
					pie.remind('上传头像失败');
				}
			}
		}
	}
	xhr.open('POST',action);
	xhr.send(new FormData(form));
});
var pu = pie.user;
pu.doLogout = function(){
	pie.pieMoment.userId = -1;
	window.localStorage.pieMoment = JSON.stringify(pie.pieMoment);
	pie.jPush.unbind();
	if(pie.useWeibo){
		var weiboFrame = document.getElementById('weiboLoginFrame');
		pie.showLoading('正在退出');
		if (weiboFrame.attachEvent){
			weiboFrame.attachEvent("onload", function(){
				window.location.reload();
			});
		}
		else {
			weiboFrame.onload = function(){
				window.location.reload();
			};
		}
		weiboFrame.src = 'http://weibo.com/logout.php?backurl=%2F';
	}
	else{
		window.location.reload();
	}
}
pu.setNotify = function(num){
	var testData = {
		'token':this.data.access_token,
		'notify_config':num
	}
	jQuery.ajax({
		url:pie.serverBase+'/api/rest/apps/pie_match/notify/config.json',
		type:'put',
		dataType:'json',
		data:testData,
		success:function(reply){},
		error:function(err){}
	})
}
pu.firstPhotoInit = function(){
	if(!('photos' in this.info)){return;}
	var pNum = this.info.photos.length;
	var smallPhotoNum = Math.min(pNum,2)-1;
	var smallPhotoHtml = "";
	for(var i = smallPhotoNum; i >= 0; i--){
		smallPhotoHtml += '<div class="firstPhoto"><img src="'+pie.serverBase+'/asset/'+this.info.photos[i].uri+'/'+90*pie.dpi+'/'+90*pie.dpi+'/smart/inline"/></div>';
	}
	jQuery('#firstPhotoArea').html(smallPhotoHtml);
}
pu.getInfo = function(sync){
	var userData = {
		'_format':'json',
		'token':this.data.access_token,
		'platform':pie.platform
	}
	if(sync){
		pie.showLoading('正在同步');
	}
	jQuery.ajax({
		url:pie.serverBase+'/api/rest/users/'+this.data.puid,
		type:'get',
		data:userData,
		dataType:'json',
		success:function(reply){
			pie.hideLoading();
			if(pie.refreshStart){
				pie.endRefresh();
			}
			if(reply.status == 'error'){
				if(reply.code == '2002'){
					pie.confirm('账号已过期,请重新登录',function(){
						pie.user.logout(0);
					},false)
				}
				else{
					pie.remind('获取基本信息出错,错误码:'+reply.code+',请报告管理员');
				}
				return;
			}
			pie.user.info = reply.data[0];
			pie.user.expectations = reply.data[1];
			if(pie.user.info.sex == true){
				pie.user.info.sex = 1;
				if(!pie.user.tips){
					pie.user.tips = pie.maleTips;
				}
			}
			else{
				pie.user.info.sex = 0;
				if(!pie.user.tips){
					pie.user.tips = pie.femaleTips;
				}
			}
			pie.backup();
			if(!sync){
				pie.tcp.init();
			}
			if(!pie.user.infoFinished){
				pie.user.firstPhotoInit();
				pie.user.initMatch(0);
			}
			pie.page.userHomePage.refresh();
		},
		error:function(err){
			pie.hideLoading();
			pie.remind('获取用户信息出错:'+err+',这应该是网络问题造成的');
		}
	})
}
pu.initMatch = function(sync){
	if(this.infoFinished){
		this.getMate(sync);
		return;
	}
	if(!this.data){return;}
	if(sync){
		pie.showLoading('正在初始化配对');
	}
	var userData = {
		'token':this.data.access_token
	}
	jQuery.ajax({
		url:pie.serverBase+'/api/rest/users/'+pie.user.data.puid+'/init.json',
		type:'patch',
		data:userData,
		dataType:'json',
		success:function(reply){
			pie.hideLoading();
			if(pie.refreshStart){
				pie.endRefresh();
			}
			if(reply.status != 'success'){
				if(reply.code == '2002'){
					pie.confirm('账号已过期,请重新登录',function(){
						pie.user.logout(0);
					},false)
				}
				else{
					jQuery('#userInputPage').css('display','block');
					jQuery('#inputCancel').css('display','none');
					jQuery('#inputSubmit').css('display','none');
					jQuery('#newInputSubmit').css('display','block');
					var mNum = null;
					var reason = null;
					if('length' in reply.message){
						mNum = reply.message.length;
						if(mNum == null||mNum<1){pie.remind('初始化配对出现未知错误');return;}
						reason = reply.message[0].property_path;
					}
					else{
						mNum = reply.message.pie_match.length;
						if(mNum == null||mNum<1){pie.remind('初始化配对出现未知错误');return;}
						reason = reply.message.pie_match[0].property_path;
					}					
					pie.atTheFirst = true;
					pie.swipePhoto = true;
					var uip = pie.page.userInputPage;
					switch(reason){
						case 'photos':
						uip.showInput('userInfoPhotos');
						break;
						case 'nickname':
						uip.showInput('userInfoNickname');
						break;
						case 'realname':
						uip.showInput('userInfoRealname');
						break;
						case 'birthday':
						uip.showInput('userInfoBirthday');
						break;
						case 'birth_place':
						uip.showInput('userInfoBirthPlace');
						break;
						case 'height':
						uip.showInput('userInfoHeight');
						break;
						case 'weight':
						uip.showInput('userInfoWeight');
						break;
						case 'degree':
						uip.showInput('userInfoDegree');
						break;
						case 'school':
						uip.showInput('userInfoSchool');
						break;
						case 'presentation':
						uip.showInput('userInfoPresentation');
						break;
						case 'current_location':
						uip.showInput('userInfoCurrentLocation');
						break;
						case 'occupation':
						uip.showInput('userInfoOccupation');
						break;
						case 'domain':
						uip.showInput('userInfoOccupation');
						break;
						case 'location_ideal':
						uip.showInput('userExpectationIdealLocation');
						break;
					}
				}
				return;
			}
			pie.swipePhoto = false;
			pie.user.infoFinished = true;
			jQuery('#inputCancel').css('display','block');
			jQuery('#inputSubmit').css('display','block');
			jQuery('#newInputSubmit').css('display','none');
			jQuery('#finishInfoButton').css('display','none');
			if(pie.atTheFirst){
				pie.atTheFirst = false;
				jQuery('#userInputPage').css('-webkit-transform','translate3d(0,0,0)');
			}
			pie.backup();
			pie.user.getMate(sync);
		},
		error:function(err){
			pie.hideLoading();
			pie.remind('初始化配对出错:'+err+',这应该是网络问题造成的');
		}
	})
}
if(pu.exist&&'access_token' in pu.data){
	pu.getInfo(0);
	pu.setNotify(0);
}
if(pie.mate.exist){
	allPage.mateHomePage.photoInit();
	pie.mate.getAnswer();
}
if(typeof(cordova) != 'undefined'){
	jQuery('#uploadPhotoSelect').css('display','none');
	jQuery('#firstUploadPhotoForm').css('display','none');
	Quo('#firstUploadPhotoButton').bind('tap',function(){
		pie.selectUploadWay();
	});
	Quo('#uploadPhotoButton').bind('tap',function(){
		pie.selectUploadWay();
	});
}